# Launch the Script file
#
# 1. Test if the given exe exists (if not found ask user to locate it)
# 2. Goto Game Directory
# 3. Launch The EXE file
# 4. After the Launch if lnk and .desktop files are found inside wine prefix
script-launch()
{
  dbug "I: Script: Launched ${FUNCNAME[0]}"
  
  source "${WINEZGUI_SCRIPTS}/script-check-variables-loaded-or-not"
  script-check-variables-loaded-or-not
  FOUND_EXE_FILES="${PREFIXDIR}/found-exe-files.yml"
  if [ -z "${1}" ]; then
       # 1. Test if the given exe exists (if not found ask user to locate it)
       script-locate-exe-function
       exe_name=$(basename "${EXE_FILE}")
       exe_path=$(dirname  "${EXE_FILE}")
  else # Use passed argument as exe file
       exe_name=$(basename "${1}")
       exe_path=$(dirname  "${1}")
  fi
  # 2. Goto Game Directory
  cd "${exe_path}"
  dbug "I: Script: Launching ${exe_name}"

  # CMDLINE exe argument 
  if [ -f "${PREFIXDIR}/cmdline.yml" ]; then
       dbug "I: Script: found CMDLINE arguments"
       EXE_ARGUMENTS=$(grep args "${PREFIXDIR}/cmdline.yml"|cut -f2 -d ":")
       dbug "I: Script: args=${EXE_ARGUMENTS}"
  fi

  # Check for Wine version change
  CURRENT_WINE_VERSION=$(${WINE_CMD} --version|cut -f1 -d " ")
  CREATED_WINE_VERSION=$(grep -i "Wine:" ${INFOFILE}|cut -f2 -d ":")
  dbug "I: Script: Created using Wine Version:${CREATED_WINE_VERSION}"
  dbug "I: Script: Current Wine Version is   :${CURRENT_WINE_VERSION}"

  if [ "${CURRENT_WINE_VERSION}" != "${CREATED_WINE_VERSION}" ]; then
       dbug "I: Script: Wine Version is different!"
       unset TEXTMSG
       TEXTMSG+="Created using Wine Version:${CREATED_WINE_VERSION}\n"
       TEXTMSG+="Current Wine Version is   :${CURRENT_WINE_VERSION}\n"
       TEXTMSG+="Update version Info?"
       unset TITLEMSG
       TITLEMSG+="Wine version mismatch!"

       ${ZENITY_CMD} --question --width 400 --title "${TITLEMSG}" --text "${TEXTMSG}"
       ANSWER=$?
       if [ ${ANSWER} -eq 0 ] && [ -w "${INFOFILE}" ]; then
            sed "s|Wine:.*|Wine:${CURRENT_WINE_VERSION}|g; t;" -i "${INFOFILE}" \
            || echo "Failed Updating: Info.yml:Wine:${CURRENT_WINE_VERSION}"
            dbug "I: Script: Updated wine version to ${CURRENT_WINE_VERSION}"
       fi
  fi

  # 3. Launch The EXE file
  ${WINE_CMD} "${exe_name}" ${EXE_ARGUMENTS}

  # 4. Remove wine installed shortcuts, unclutters menu
  source "${WINEZGUI_SCRIPTS}/winezgui-remove-wine-created-shortcuts"
  winezgui-remove-wine-created-shortcuts

  # Detect Setup or Direct Play exe
#   TEST_NAME=$(echo "${exe_name}"| tr [A-Z] [a-z]) # Change case to test
#   if [[ "${TEST_NAME}" == *"setup"* ]]   2>/dev/null || \
#      [[ "${TEST_NAME}" == *"install"* ]] ; then
#        dbug "I: Script: Launching =-= SETUP INSTALLER =-="
#      #   source "${WINEZGUI_SCRIPTS}/script-change-exe-and-prefix"
#      #   script-change-exe-and-prefix
#        source "${WINEZGUI_SCRIPTS}/script-create-shortcuts-for-found-exes"
#        script-create-shortcuts-for-found-exes
#   else
#        dbug "I: Script: Launching script find exe"
#        source "${WINEZGUI_SCRIPTS}/script-find-installed-exe"
#        script-find-installed-exe
#   fi
  # On 1st run create shortcuts for all found exe
  if [ -f "${FOUND_EXE_FILES}" ]; then
       source "${WINEZGUI_SCRIPTS}/script-find-installed-exe"
       script-find-installed-exe
  else # from 2nd run onwards, detect new exe files.
       dbug "I: SCRIPT LAUNCH: 1st launch detected........................"
       source "${WINEZGUI_SCRIPTS}/script-create-shortcuts-for-found-exes"
       script-create-shortcuts-for-found-exes 
  fi
}
