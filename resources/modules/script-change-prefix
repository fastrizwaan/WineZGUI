##### Rename Prefix Directory ####
# script-change-prefix
# Steps:
# 1. Ask for New Prefix Name
# 2. replace " " with "_" (underscore)
# 3. If a prefix with given name already exist, inform
# 4. Create Variables for replacement
# 5. Replace PREFIX values inside files
# 6. Rename files as per new prefix name
# 7. Create new shortcut and delete old one
# 8. Launch Script from Renamed Directory
Script_Change_Prefix()
{ 
  DBUG "I: Script: Launched ${FUNCNAME[0]}"
  
  source "${WINEZGUI_SCRIPTS}/script-check-variables-loaded-or-not"
  Script_Check_Variables_Loaded_Or_Not
  export PREFIXES_DIR="${WINEZGUIDIR}/Prefixes"
  # If No argument is given ask
  if [ -z "${1}" ]; then
      # 1. Ask for New Prefix Name if not provided by argument
      GET_PREFIX_NAME=$(${ZENITY_CMD} --title "Rename Prefix..."             \
                               --width=500 --entry                    \
                               --text "Enter a name for the prefix"   \
                               --entry-text "${PREFIXNAME}"           )
  else
      GET_PREFIX_NAME="${1}"
  fi

  # 1.1 If User clicks cancel, go back
  if [ -z "${GET_PREFIX_NAME}" ]; then
      DBUG "I: Script: ${FUNCNAME[0]}: Cancelled"
      Script_Window
  fi

  # Check if user entered symbols
  source "${WINEZGUI_SCRIPTS}/winezgui-check-entry-text"
  WineZGUI_Check_Entry_Text "${GET_PREFIX_NAME}"
  
  ENTRY_CHECK=$?
  if [ ${ENTRY_CHECK} -eq 1 ]; then
       DBUG "I: Script: ${FUNCNAME[0]}: Symbols used in filename, cancelling!"
       return 1
  fi
  

  # 2. replace " " with "_" (underscore)
  NEWPREFIXNAME=$(echo ${GET_PREFIX_NAME}|tr " " "_")


  # 3. If a prefix with given name already exist, inform
  if [ -d "${PREFIXES_DIR}/${NEWPREFIXNAME}" ]; then
      ${ZENITY_CMD} --error --title="Directory Already Exists!" \
              --text="Cannot change ${PREFIXNAME} to ${NEWPREFIXNAME}"

      DBUG "I: Script: ${FUNCNAME[0]}: Cannot change to ${NEWPREFIXNAME}"
      DBUG "I: Script: ${FUNCNAME[0]}: ${PREFIXNAME} Already Exists!"
      echo "W: -----------------------------"
      echo "W: setting prefixname in desktop file"
      echo "W: Application (PREFIXNAME)"
      sed "s|${APP_WITH_VER}|${PREFIXNAME}|g" -i "*.desktop"
      return 1
  fi

  # 4. Create Variables for replacement
  NEWPREFIXDIR="${PREFIXES_DIR}/${NEWPREFIXNAME}"
  NEWSCRIPTFILE="$(basename ${SCRIPTFILE})"

  echo "NEWPREFIXDIR  = $NEWPREFIXDIR"
  echo "NEWPREFIXNAME = $NEWPREFIXNAME"
  echo "NEWSCRIPTFILE = $NEWSCRIPTFILE"
  # Main Replacement
  # Change Variables inside Script file which has PREFIXNAME
  # 5.4 Change export PREFIXNAME= Variable to new prefix name value

  # 5.4.0 Desktop File
  cd ${PREFIXDIR}

  S_PREFIXDIR="${PREFIXDIR}"
  R_PREFIXDIR="${NEWPREFIXDIR}"

  sed "s|${S_PREFIXDIR}|${R_PREFIXDIR}|g"     -i *.desktop *.sh *.yml
  
  # 5.4.1 Change Values inside Script file
#   S_PREFIXDIR="^export PREFIXDIR=.*"
#   R_PREFIXDIR="export PREFIXDIR=\"${NEWPREFIXDIR}\""
#   sed "s|${S_PREFIXDIR}|${R_PREFIXDIR}|g"     -i "*.sh"

  S_PREFIXNAME="^export PREFIXNAME=.*"
  R_PREFIXNAME="export PREFIXNAME=\"${NEWPREFIXNAME}\""
  sed "s|${S_PREFIXNAME}|${R_PREFIXNAME}|g"   -i *.sh

  # 5.4.2 Change values inside Info.yml
  sed "s|^Prefix:.*|Prefix:${NEWPREFIXNAME}|g" -i *.yml



   # 6.4 Rename: Prefix Directory
   mv "${PREFIXDIR}" "${PREFIXES_DIR}/${NEWPREFIXNAME}" && \
   echo  "I: Script: Rename: Prefix: Renamed directory ${PREFIXNAME}" \
       "-> ${NEWPREFIXNAME}"

  # 7. Create new shortcut and delete old one
  # 7.1 link new .desktop file to desktopdir
  ln -svf "${NEWPREFIXDIR}"/*.desktop ${DESKTOPDIR} && \
  echo   "I: Script: Rename: Prefix: Created shortcut for ${NEWDESKTOPFILE}" \
          "at ${DESKTOPDIR}" 2>/dev/null || \
  echo   "E: Script: Rename: Prefix: Create Shortcut Failed!!!"

  # 7.2 Delete all broken links which points to winezgui game prefix
  find ${DESKTOPDIR} -maxdepth 1 -xtype l -delete && \
  DBUG "I: Script: ${FUNCNAME[0]}: Removed broken WineZGUI .desktop links"

  # 7.3 update icon cache and desktop menu
  # Clean up broken shortcuts and update shortcuts menu
  source "${DATADIR}/winezgui-remove-broken-links" 2>/dev/null || \
  source "${WINEZGUI_SCRIPTS}/winezgui-remove-broken-links"
  WineZGUI_Remove_Broken_Links


  # Required for instant change in the GameWindow
  export PREFIXNAME="${NEWPREFIXNAME}"
  export PREFIXDIR="${NEWPREFIXDIR}"
  #export SCRIPTFILE="${NEWSCRIPTFILE}"
  export ICONFILE="${NEWICONFILE}"
  export DESKTOPFILE="${NEWDESKTOPFILE}"
  DBUG "I: Script: ${FUNCNAME[0]}: starting script from renamed dir"

  NEW_SCRIPT_FILE="${NEWPREFIXDIR}/$(basename ${SCRIPTFILE})"


  # 8. Launch Script from Renamed Directory
  "${NEW_SCRIPT_FILE}" &

  unset GET_PREFIX_NAME
  unset NEWPREFIXNAME
  unset NEWPREFIXDIR
  unset NEW_EXE_FILE
  unset NEW_EXE_PATH
  unset NEWSCRIPTFILE
  unset NEWICONFILE
  unset NEWDESKTOPFILE
  exit 0 
}
