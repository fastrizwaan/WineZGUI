#!/bin/bash

# On 1st launch create default wine prefix
export APPNAME=WineZGUI
export WINEVER=$(wine --version|cut -f1 -d ' ')
export WINEZPREFIX="$(realpath -m ~/.local/share/winezgui)"
export PREFIXDIR="${WINEZPREFIX}/default"
export WINEARCH=win64
#export WINEDLLOVERRIDES="mscoree,mshtml="
export LD_LIBRARY_PATH=/app/lib:/app/lib32:/app/lib64:/app/lib/i386-linux-gnu:/app/lib/wine:/app/lib64/wine:/app/$NAME:$(pwd)
export PATH=$PATH:$(pwd)
export BINDIR=/usr/bin
export ARGV="$@"
#export WINEEXE="flatpak run org.winehq.Wine"
export WINEEXE="$(which wine)"
export WINETRICKS="$(which winetricks)"
#export WINETRICKS="PREFIX=${PREFIXDIR} flatpak run --command=winetricks org.winehq.Wine"

    EXE_FILE=$(realpath -m "$1")
    EXE_NAME=$(basename "$EXE_FILE")
    EXE_PATH=$(dirname  "$EXE_FILE")
	  EXE_NOSP=$(echo $EXE_NAME|tr ' ' '_');
 	  EXE_NOEXE=$(echo $EXE_NOSP|sed "s/\.exe//g");
    WINEPREFIX_SUBDIR="${WINEZPREFIX}/$EXE_NOEXE"    
      
# some games need to cd to the dir to work
export base=$(basename "$1")
export dire=$(dirname  "$1")

#echo $base >> ~/Documents/debug.txt
#echo $dire >> ~/Documents/debug.txt
# Create kill shortcut for convenience
# debug
echo WINEZPREFIX = ${WINEZPREFIX}
echo PREFIXDIR = ${PREFIXDIR}
mkdir -pv "${PREFIXDIR}"


   # sandboxify by rm links to user's ~/Documents ~/Downloads ~/Videos etc.
   # to prevent games/programs from saving/writing to ~/Documents for backup purpose
   if [ ! -f ${PREFIXDIR}/default.symlinks-removed ]; then
    
    # Create Prefix and delete base system linked directory links 
    WINEDLLOVERRIDES="mscoree,mshtml=" \
    WINEPREFIX=${PREFIXDIR} \
    wineboot -u && \
    
    rm -rf ${PREFIXDIR}/drive_c/users/$USER/Desktop
	  rm -rf ${PREFIXDIR}/drive_c/users/$USER/Downloads
	  rm -rf ${PREFIXDIR}/drive_c/users/$USER/'My Documents'
	  rm -rf ${PREFIXDIR}/drive_c/users/$USER/'My Music'
	  rm -rf ${PREFIXDIR}/drive_c/users/$USER/'My Pictures'
	  rm -rf ${PREFIXDIR}/drive_c/users/$USER/'My Videos' 
	  rm -rf ${PREFIXDIR}/drive_c/users/$USER/Templates

	  #Create normal folders for the deleted symlinks
	  mkdir -p ${PREFIXDIR}/drive_c/users/$USER/Desktop
	  mkdir -p ${PREFIXDIR}/drive_c/users/$USER/Downloads
	  mkdir -p ${PREFIXDIR}/drive_c/users/$USER/'My Documents'
	  mkdir -p ${PREFIXDIR}/drive_c/users/$USER/'My Music'
	  mkdir -p ${PREFIXDIR}/drive_c/users/$USER/'My Pictures'
	  mkdir -p ${PREFIXDIR}/drive_c/users/$USER/'My Videos' 
	  mkdir -p ${PREFIXDIR}/drive_c/users/$USER/Templates

	  touch ${PREFIXDIR}/default.symlinks-removed
   fi


# flatpak-wine-gui.sh
# for GUI Dialog
if [ $# -eq 0 ];  then
   echo "No arguments supplied; use --help"
 
   choice=$(zenity --title "${APPNAME} (${WINEVER})" --width=240 --height=300 \
					 --list \
					 --radiolist --column " " \
					 --column "Action" \
							  0 "Run Winetricks..." \
							  0 "Install Custom DLLs..." \
							  0 "Install Media Foundation Libraries" \
							  0 "Launch Winecfg..." \
						   TRUE "Open Explorer++" \
						      0 "Open Shell..." \
                              0 "Kill all Instances" \
							  0 "Delete Bottle" \
					 --text "Select Action for ${PREFIXDIR} " )

   # exit when Cancel is clicked
   [[ -z "$choice" ]] && exit 1
   
	if [ "$choice" = "Run Winetricks..." ]; then  
	   PREFIX=${PREFIXDIR} $WINETRICKS --gui

    # mydlls
	elif [ "$choice" = "Install Custom DLLs..." ]; then
	mydlls=$(zenity --title "Install custom dlls - Paste your list " --text "or Press enter to install (xact xinput xna31 vcrun2003-2012 d3dx9 d9vk)" --entry)
    if [ -z "$mydlls" ]; #if no dlls are given
       then         
       mydlls=(dotnet35 xna31 xinput xact faudio dxvk dotnet40 dotnet45 dotnet48 vcrun2003 vcrun2005 vcrun2008 vcrun2012 vcrun2015 corefonts mf quartz)
    else   
    mydlls=( $mydlls ) ; #convert string to array
    fi
    
size=${#mydlls[*]}
size=$(expr $size + 1) ;# add +1 for progress

step=$(expr 100 / $size)
prog=$(echo $step)
echo $size $step ${mydlls[*]}

	( for i in ${mydlls[*]};
	  do
    	echo $prog
	    echo "# Installing $i..."
	    PREFIX=${PREFIXDIR} $WINETRICKS --unattended  $i
      
        prog=$(expr $prog + $step)
	  done
	  echo 100
	  echo "# Done!"
	) | zenity --width=340 --title "Installing Custom DLLs with Winetricks" --progress --auto-kill
	
	# Install Media Foundation Libraries
	elif [ "$choice" = "Install Media Foundation Libraries" ]; then
	   cd /app/mf-install && PREFIX=${PREFIXDIR} sh mf-install.sh
    
	# winecfg
	elif [ "$choice" = "Launch Winecfg..." ]; then
	   PREFIX=${PREFIXDIR} winecfg
       
    elif [ "$choice" = "Kill all Instances" ]; then
	   killall -KILL wineserver
    elif [ "$choice" = "Open Shell..." ]; then   
       gnome-terminal -- bash #-c "PREFIX=${PREFIXDIR}"
	elif [ "$choice" = "Delete Bottle" ]; then
	   rm -rfv ${PREFIXDIR}; 

	elif [ "$choice" = "Open Explorer++" ]; then
	   PREFIX=${PREFIXDIR} $WINEEXE /app/explorer++/Explorer++.exe
	   
	else
	   PREFIX=${PREFIXDIR} $WINEEXE /app/explorer++/Explorer++.exe

	fi
    # /for GUI Dialog
else


   # Prompt to open with Bottle if already bottle is created
   EXE_FILE=$(basename "$1")
   EXE_FILENAME_NO_SPACE=$(echo $EXE_FILE|tr ' ' '_')
   echo $EXE_FILE
   ls ${WINEZPREFIX}/${EXE_FILENAME_NO_SPACE}/"$EXE_FILE.sh"
   
   # If existing prefix exists for the exe
   if [ -f  ${WINEZPREFIX}/${EXE_NOEXE}/"$EXE_NOEXE.sh" ]; then
   
      choice=$(zenity --title "${APPNAME} (${WINEVER})" --width=500 --height=300 \
	    				 --list \
		    			 --radiolist --column " " \
			    		 --column "Action" \
						   0 "Run $EXE_FILE using Default bottle" \
						TRUE "Run $EXE_FILE using existing $basename bottle" \
						   0 "Run $EXE_FILE configuration" \
					 --text "Select Action for ${PREFIXDIR} " )
   else
   choice=$(zenity --title "${APPNAME} (${WINEVER})" --width=500 --height=300 \
					 --list \
					 --radiolist --column " " \
					 --column "Action" \
						   TRUE "Run $EXE_FILE using Default bottle" \
							  0 "Create Bottle for $EXE_FILE" \
					 --text "Select Action for ${PREFIXDIR} " )
    fi
   # exit when Cancel is clicked
   [[ -z "$choice" ]] && exit 1
   
	if [ "$choice" = "Run $EXE_FILE using Default bottle" ]; then  
	   cd "$dire" 2>/dev/null;#go to the exe directory then run
       PREFIX=${PREFIXDIR} $WINEEXE "$@"

    # Create bottle
	elif [ "$choice" = "Create Bottle for $EXE_FILE" ]; then
         $BINDIR/winezgui-create-prefix "$1"
    elif [ "$choice" = "Run $EXE_FILE using existing $basename bottle" ]; then
	    # We replace "name with space" to "name_with_space"
	    EXE_FILENAME_NO_SPACE=$(echo $EXE_FILE|tr ' ' '_')
	    ${WINEPREFIX_SUBDIR}/"$EXE_NOEXE.sh" "launch"
	elif [ "$choice" = 	"Run $EXE_FILE configuration" ]; then
		EXE_FILENAME_NO_SPACE=$(echo $EXE_FILE|tr ' ' '_')
	    ${WINEPREFIX_SUBDIR}/"$EXE_NOEXE.sh"
	fi
	

fi

